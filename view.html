<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Letters â€“ Quiet Letters</title>
  <link rel="icon" type="image/png" href="images/seal_favicon.png" />

  <!-- Prevent flash of wrong theme -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', saved || (prefersDark ? 'dark' : 'light'));
    })();
  </script>

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="images/seal_favicon.png" alt="Quiet Letters" />
      </a>
      
      <nav class="sidebar-nav" aria-label="Main navigation">
        <a href="index.html" title="Home" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.126 1.126 0 011.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
        </a>
        <a href="letter.html" title="Write Letter" aria-label="Write Letter">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
          </svg>
        </a>
        <a href="view.html" class="active" title="View Letters" aria-label="View Letters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
          </svg>
        </a>
      </nav>
      
      <div class="sidebar-bottom">
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content" tabindex="-1">
      <!-- Top Header -->
      <header class="top-header">
        <div class="search-container">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search your letters..." aria-label="Search letters" autocomplete="off">
          <div class="search-suggestions" id="searchSuggestions" role="listbox" aria-label="Search suggestions"></div>
        </div>
        
        <div class="header-right">
          <div class="user-profile">
            <div class="user-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
              </svg>
            </div>
            <span class="user-name">Guest</span>
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
            <!-- Sun icon (shown in dark mode) -->
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
            <!-- Moon icon (shown in light mode) -->
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <header class="page-header">
          <h1>Sent Letters</h1>
          <p class="subtitle sent-info">
            Your letters are stored only in this browser using local storage.
            If you clear cookies or site data, all saved letters will be permanently deleted.
          </p>
        </header>

        <div class="divider-line"></div>

        <section aria-label="Your sent letters">
          <div id="lettersGrid" class="letters-grid" role="list" aria-live="polite"></div>

          <div style="margin-top: 48px;">
            <a href="letter.html" class="start-btn" aria-label="Write another letter">
              Write another letter
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
              </svg>
            </a>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Tooltip that follows the mouse -->
  <div id="letterTooltip" class="letter-tooltip hidden" role="tooltip"></div>

  <script>
    /* ------------------------------
       HELPERS
    ------------------------------ */

    function getLetters() {
      const raw = localStorage.getItem("sentLetters");
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function getOpenInfo(letter) {
      const writtenStr = letter.date;
      const openAfterDays =
        typeof letter.openAfterDays === "number"
          ? letter.openAfterDays
          : parseInt(letter.openAfterDays, 10);

      const baseDateStr = letter.createdAt || letter.date;
      const baseDate = new Date(baseDateStr);
      const writtenDate = new Date(writtenStr || baseDateStr);

      const isBaseValid = !isNaN(baseDate);
      const isWrittenValid = !isNaN(writtenDate);

      const writtenLabel = isWrittenValid
        ? writtenDate.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric"
          })
        : (writtenStr || "Unknown date");

      const daysDelay = Number.isNaN(openAfterDays) ? 0 : openAfterDays;

      let openDate = null;
      let openLabel = "Ready to open";
      let daysLeft = 0;

      if (isBaseValid) {
        openDate = new Date(
          baseDate.getTime() + daysDelay * 24 * 60 * 60 * 1000
        );

        const now = new Date();
        const msDiff = openDate - now;
        daysLeft = Math.ceil(msDiff / (1000 * 60 * 60 * 24));

        if (daysLeft > 0) {
          openLabel = openDate.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric"
          });
        }
      }

      const isLocked = daysLeft > 0;
      const statusText = isLocked ? `Opens in ${daysLeft}d` : "Ready to open";

      return {
        writtenLabel,
        openLabel,
        statusText,
        isLocked,
        daysLeft
      };
    }

    /* ------------------------------
       TOOLTIP POSITIONING
    ------------------------------ */
    function updateTooltipPosition(event, tooltip) {
      const offsetX = 18;
      const offsetY = 18;
      tooltip.style.left = event.clientX + offsetX + "px";
      tooltip.style.top = event.clientY + offsetY + "px";
    }

    /* ------------------------------
       MAIN RENDERING
    ------------------------------ */

    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("lettersGrid");
      const tooltip = document.getElementById("letterTooltip");
      const letters = getLetters();

      if (!letters.length) {
        grid.innerHTML = `<p class="subtitle">No letters have been sent yet.</p>`;
        return;
      }

      letters.forEach((letter, index) => {
        const { writtenLabel, openLabel, statusText, isLocked } =
          getOpenInfo(letter);

        const card = document.createElement("a");
        card.className = "sent-letter-card" + (isLocked ? " locked" : "");
        card.href = `letter_view.html?id=${index}`;
        card.style.textDecoration = "none";
        
        // Accessibility attributes
        card.setAttribute("role", "article");
        card.setAttribute("aria-label", `Letter ${index + 1}: ${isLocked ? "Locked - " + statusText : "Ready to open"}`);
        card.setAttribute("tabindex", "0");

        // Tooltip data
        card.dataset.letterIndex = index + 1;
        card.dataset.written = writtenLabel;
        card.dataset.openLabel = openLabel;
        card.dataset.statusText = statusText;

        card.innerHTML = `
          <div class="sent-letter-image-wrapper">
            <img
              src="images/Closed_Letter.png"
              alt="Letter ${index + 1}${isLocked ? ' - locked until ' + openLabel : ' - ready to open'}"
              class="sent-letter-image"
            />
          </div>
        `;

        grid.appendChild(card);

        /* ------------------------------
           BLOCK NAVIGATION ON LOCKED LETTERS
        ------------------------------ */
        card.addEventListener("click", (e) => {
          if (card.classList.contains("locked")) {
            e.preventDefault();
            e.stopPropagation();

            // shake animation
            const wrapper = card.querySelector(".sent-letter-image-wrapper");
            wrapper.classList.remove("shake-now");
            void wrapper.offsetWidth; // restart animation
            wrapper.classList.add("shake-now");
          }
        });

        /* ------------------------------
           TOOLTIP EVENTS
        ------------------------------ */
        card.addEventListener("mouseenter", (e) => {
          const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
          const xIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
          
          const statusPill = isLocked 
            ? `<span class="status-pill locked">${xIcon}${card.dataset.statusText}</span>`
            : `<span class="status-pill ready">${checkIcon}Ready to open</span>`;
          
          tooltip.innerHTML = `
            <div class="letter-tooltip-title">Letter ${card.dataset.letterIndex}</div>
            <div class="letter-tooltip-line">Written: ${card.dataset.written}</div>
            ${isLocked ? `<div class="letter-tooltip-line">Opens: ${card.dataset.openLabel}</div>` : ''}
            <div class="letter-tooltip-line emphasize">${statusPill}</div>
          `;
          tooltip.classList.remove("hidden");
          updateTooltipPosition(e, tooltip);
        });

        card.addEventListener("mousemove", (e) => {
          updateTooltipPosition(e, tooltip);
        });

        card.addEventListener("mouseleave", () => {
          tooltip.classList.add("hidden");
        });
      });
    });
  </script>
  <script src="js/search.js"></script>
  <script src="js/theme.js"></script>

</body>
</html>
