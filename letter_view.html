<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Read Letter – Quiet Letters</title>
  <link rel="icon" type="image/png" href="images/seal_favicon.png" />

  <!-- Prevent flash of wrong theme -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', saved || (prefersDark ? 'dark' : 'light'));
    })();
  </script>

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="images/seal_favicon.png" alt="Quiet Letters" />
      </a>
      
      <nav class="sidebar-nav" aria-label="Main navigation">
        <a href="index.html" title="Home" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.126 1.126 0 011.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
        </a>
        <a href="letter.html" title="Write Letter" aria-label="Write Letter">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
          </svg>
        </a>
        <a href="view.html" class="active" title="View Letters" aria-label="View Letters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
          </svg>
        </a>
      </nav>
      
      <div class="sidebar-bottom">
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content" tabindex="-1">
      <!-- Top Header -->
      <header class="top-header">
        <div class="search-container">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search your letters..." aria-label="Search letters" autocomplete="off">
          <div class="search-suggestions" id="searchSuggestions" role="listbox" aria-label="Search suggestions"></div>
        </div>
        
        <div class="header-right">
          <div class="user-profile">
            <div class="user-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
              </svg>
            </div>
            <span class="user-name">Guest</span>
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
            <!-- Sun icon (shown in dark mode) -->
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
            <!-- Moon icon (shown in light mode) -->
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <div class="letter-view-layout">
          <!-- Left side: Letter Paper Preview -->
          <section aria-label="Letter content" class="letter-preview-container" id="letterContentSection">
            <!-- Locked state: show locked message -->
            <div id="lockedNotice" class="letter-paper hidden">
              <div class="letter-content locked-content">
                <div class="locked-info">
                  <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                  </svg>
                  <p class="locked-countdown" id="lockedCountdown"></p>
                  <p class="locked-date" id="lockedOpenDate"></p>
                </div>
              </div>
            </div>

            <!-- Open state: show letter paper -->
            <div id="openContent" class="letter-paper hidden">
              <div class="letter-content">
                <p class="preview-to" id="previewTo"></p>
                <p class="preview-message" id="letterMessage"></p>
                <p class="preview-signature" id="signatureText"></p>
              </div>
            </div>
          </section>

          <!-- Right side: Letter Info & Actions -->
          <aside class="letter-view-sidebar">
            <header class="sidebar-header">
              <span class="sidebar-eyebrow">From your past self</span>
              <h1 class="sidebar-title" id="letterStatusText">Your letter</h1>
            </header>

            <div class="letter-meta-card">
              <div class="meta-row">
                <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
                </svg>
                <div class="meta-content">
                  <span class="meta-label">Written</span>
                  <span class="meta-value" id="writtenDateLabel"></span>
                </div>
              </div>
              <div class="meta-row">
                <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
                <div class="meta-content">
                  <span class="meta-label">Opens</span>
                  <span class="meta-value" id="openDateLabel"></span>
                </div>
              </div>
            </div>

            <div class="sidebar-actions">
              <a href="view.html" class="start-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Back to letters
              </a>
            </div>

            <div class="share-section">
              <span class="share-label">Bookmark this letter</span>
              <p class="share-helper-text">This link only works in this browser</p>
              <div class="share-link-row" id="shareLinkRow">
                <input
                  type="text"
                  id="shareUrlInput"
                  class="form-input share-input"
                  readonly
                  aria-label="Shareable link to this letter"
                />
                <button id="copyLinkBtn" class="copy-btn" aria-label="Copy link to clipboard">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                  </svg>
                </button>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- helpers ---

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function getLetters() {
      const raw = localStorage.getItem("sentLetters");
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function computeTiming(letter) {
      const openAfterDays =
        typeof letter.openAfterDays === "number"
          ? letter.openAfterDays
          : parseInt(letter.openAfterDays, 10);

      const baseDateStr = letter.createdAt || letter.date;
      const baseDate = new Date(baseDateStr);
      const writtenDate = new Date(letter.date || baseDateStr);

      const isBaseValid = !isNaN(baseDate);
      const isWrittenValid = !isNaN(writtenDate);

      const writtenLabel = isWrittenValid
        ? writtenDate.toLocaleDateString("en-US", {
            month: "long",
            day: "numeric",
            year: "numeric"
          })
        : (letter.date || "Unknown date");

      const safeDelay = Number.isNaN(openAfterDays) ? 0 : openAfterDays;

      let openDate = null;
      let openLabel = "Ready to open";
      let daysLeft = 0;

      if (isBaseValid) {
        openDate = new Date(
          baseDate.getTime() + safeDelay * 24 * 60 * 60 * 1000
        );
        const now = new Date();
        const msDiff = openDate - now;
        daysLeft = Math.ceil(msDiff / (1000 * 60 * 60 * 24));

        openLabel =
          "Opens on " +
          openDate.toLocaleDateString("en-US", {
            month: "long",
            day: "numeric",
            year: "numeric"
          });
      }

      const isLocked = openDate && daysLeft > 0;

      return {
        writtenLabel,
        openLabel,
        openDate,
        isLocked,
        daysLeft
      };
    }

    function updateCountdown(openDate, targetEl) {
      if (!openDate || !targetEl) return;

      const now = new Date();
      const msDiff = openDate - now;

      if (msDiff <= 0) {
        targetEl.textContent = "Your letter is ready to open.";
        return;
      }

      const days = Math.floor(msDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((msDiff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((msDiff / (1000 * 60)) % 60);

      targetEl.textContent =
        `Opens in ${days}d ${hours}h ${minutes}m`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const idStr = getQueryParam("id");
      const index = parseInt(idStr, 10);

      const statusText = document.getElementById("letterStatusText");
      const lockedNotice = document.getElementById("lockedNotice");
      const openContent = document.getElementById("openContent");

      if (Number.isNaN(index)) {
        statusText.textContent = "Letter not found.";
        return;
      }

      const letters = getLetters();
      const letter = letters[index];

      if (!letter) {
        statusText.textContent = "Letter not found.";
        return;
      }

      // Fill share URL
      const shareInput = document.getElementById("shareUrlInput");
      shareInput.value = window.location.href;

      // Timing
      const { writtenLabel, openLabel, openDate, isLocked } =
        computeTiming(letter);

      const openDateLabel = document.getElementById("openDateLabel");
      const writtenDateLabel = document.getElementById("writtenDateLabel");
      const previewTo = document.getElementById("previewTo");
      const signatureText = document.getElementById("signatureText");
      const messageEl = document.getElementById("letterMessage");
      const lockedCountdown = document.getElementById("lockedCountdown");
      const lockedOpenDate = document.getElementById("lockedOpenDate");

      openDateLabel.textContent = openLabel.replace("Opens on ", "");
      writtenDateLabel.textContent = writtenLabel;

      // Fill letter preview content
      previewTo.textContent = letter.name ? `Dear ${letter.name},` : "Dear friend,";
      messageEl.textContent = letter.message || "";
      signatureText.textContent = letter.signature
        ? "— " + letter.signature
        : "";

      if (isLocked) {
        statusText.textContent = "Sealed letter";
        lockedNotice.classList.remove("hidden");
        openContent.classList.add("hidden");

        if (openDate) {
          lockedOpenDate.textContent = openLabel;
          updateCountdown(openDate, lockedCountdown);
          setInterval(
            () => updateCountdown(openDate, lockedCountdown),
            60 * 1000
          );
        }
      } else {
        statusText.textContent = letter.name ? `Letter to ${letter.name}` : "Your letter";
        lockedNotice.classList.add("hidden");
        openContent.classList.remove("hidden");
      }

      // Copy button
      const copyBtn = document.getElementById("copyLinkBtn");
      copyBtn.addEventListener("click", () => {
        shareInput.select();
        shareInput.setSelectionRange(0, 99999);
        try {
          document.execCommand("copy");
          copyBtn.classList.add("copied");
          setTimeout(() => copyBtn.classList.remove("copied"), 1500);
        } catch (e) {
          console.error("Copy failed:", e);
        }
      });
    });
  </script>

  <script src="js/search.js"></script>
  <script src="js/theme.js"></script>
</body>
</html>
