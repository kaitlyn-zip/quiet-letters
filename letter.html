<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Write a Letter – Quiet Letters</title>
  <link rel="icon" type="image/png" href="images/seal_favicon.png" />

  <!-- Prevent flash of wrong theme -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', saved || (prefersDark ? 'dark' : 'light'));
    })();
  </script>

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="images/seal_favicon.png" alt="Quiet Letters" />
      </a>
      
      <nav class="sidebar-nav" aria-label="Main navigation">
        <a href="index.html" title="Home" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.126 1.126 0 011.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
        </a>
        <a href="letter.html" class="active" title="Write Letter" aria-label="Write Letter">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
          </svg>
        </a>
        <a href="view.html" title="View Letters" aria-label="View Letters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
          </svg>
        </a>
      </nav>
      
      <div class="sidebar-bottom">
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content" tabindex="-1">
      <!-- Top Header -->
      <header class="top-header">
        <div class="search-container">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search your letters..." aria-label="Search letters" autocomplete="off">
          <div class="search-suggestions" id="searchSuggestions" role="listbox" aria-label="Search suggestions"></div>
        </div>
        
        <div class="header-right">
          <div class="user-profile">
            <div class="user-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
              </svg>
            </div>
            <span class="user-name">Guest</span>
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
            <!-- Sun icon (shown in dark mode) -->
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
            <!-- Moon icon (shown in light mode) -->
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22" height="22">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <header class="page-header-enhanced">
          <span class="eyebrow-label">Compose</span>
          <h1>Write your letter</h1>
          <p class="subtitle">
            Write something you'd like your future self to know.
            Your words are private and stored locally on this device.
          </p>
        </header>

        <section aria-label="Letter form" class="letter-composer">
          <!-- Left side: Form -->
          <div class="form-card">
            <form id="letterForm">
              <!-- To (Name) -->
              <div class="field-group field-group-enhanced">
                <div class="field-label-row">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                  </svg>
                  <label for="name">To</label>
                </div>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-input"
                  placeholder="Who is this letter for?"
                  maxlength="25"
                >
                <span class="char-counter" id="nameCounter">0/25</span>
              </div>

              <!-- From (Signature) - Optional -->
              <div class="field-group field-group-enhanced">
                <div class="field-label-row">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" />
                  </svg>
                  <label for="signature">From <span class="label-badge">Optional</span></label>
                </div>
                <input
                  type="text"
                  id="signature"
                  name="signature"
                  class="form-input"
                  placeholder="Leave blank to stay anonymous"
                  maxlength="25"
                >
                <span class="char-counter" id="signatureCounter">0/25</span>
              </div>

              <!-- Message -->
              <div class="field-group field-group-enhanced">
                <div class="field-label-row">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                  </svg>
                  <label for="message">Your message</label>
                </div>
                <textarea
                  id="message"
                  name="message"
                  class="form-textarea"
                  placeholder="What do you want to tell your future self?"
                  maxlength="500"
                ></textarea>
                <span class="char-counter" id="messageCounter">0/500</span>
              </div>

              <!-- Date (hidden, auto-filled) -->
              <input type="hidden" id="date" name="date">

              <!-- Open after X days -->
              <div class="field-group field-group-enhanced">
                <div class="field-label-row">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                  </svg>
                  <label for="openAfterDays">Time capsule delay</label>
                </div>
                <input
                  type="number"
                  id="openAfterDays"
                  name="openAfterDays"
                  class="form-input"
                  min="0"
                  step="1"
                  placeholder="Enter days (e.g., 365 for 1 year)"
                  aria-describedby="openAfterHelp"
                >
                <p id="openAfterHelp" class="field-helper">
                  Enter <strong>0</strong> to read immediately, <strong>30</strong> for a month, or <strong>365</strong> for a year.
                </p>
              </div>

              <button type="submit" class="start-btn" aria-label="Seal and send your letter">
                Seal & send letter
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
              </button>
              
              <a href="view.html" class="view-link" style="margin-top: 16px;" aria-label="View all your sent letters">view sent letters</a>
            </form>
          </div>

          <!-- Right side: Letter Preview -->
          <div class="letter-preview-container">
            <div class="letter-paper">
              <div class="letter-content">
                <p class="preview-to" id="previewTo">My love,</p>
                <p class="preview-message" id="previewMessage"></p>
                <p class="preview-signature" id="previewSignature"></p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("date");
      const openAfterInput = document.getElementById("openAfterDays");

      // Auto-fill today's date
      if (dateInput) {
        const today = new Date().toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric"
        });
        dateInput.value = today;
      }

      // Set a nice default for open-after days (1 year)
      const defaultOpenAfterDays = 365;
      if (openAfterInput && !openAfterInput.value.trim()) {
        openAfterInput.value = defaultOpenAfterDays;
      }

      // Character counter functionality
      function setupCharCounter(inputId, counterId, maxLength) {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(counterId);
        if (!input || !counter) return;

        function updateCounter() {
          const currentLength = input.value.length;
          counter.textContent = `${currentLength}/${maxLength}`;
          
          // Add warning/error classes
          counter.classList.remove('warning', 'error');
          if (currentLength >= maxLength) {
            counter.classList.add('error');
          } else if (currentLength >= maxLength * 0.8) {
            counter.classList.add('warning');
          }
        }

        input.addEventListener('input', updateCounter);
        updateCounter(); // Initialize
      }

      setupCharCounter('name', 'nameCounter', 25);
      setupCharCounter('signature', 'signatureCounter', 25);
      setupCharCounter('message', 'messageCounter', 500);

      // Live preview functionality
      const nameInput = document.getElementById('name');
      const signatureInput = document.getElementById('signature');
      const messageInput = document.getElementById('message');
      
      const previewTo = document.getElementById('previewTo');
      const previewMessage = document.getElementById('previewMessage');
      const previewSignature = document.getElementById('previewSignature');

      function updatePreview() {
        // Update "To:" field
        const toValue = nameInput.value.trim();
        previewTo.textContent = toValue ? `To: ${toValue}` : 'To:';
        
        // Update message
        previewMessage.textContent = messageInput.value;
        
        // Update signature
        const sigValue = signatureInput.value.trim();
        previewSignature.textContent = sigValue ? `— ${sigValue}` : '';
      }

      // Add event listeners for live preview
      nameInput.addEventListener('input', updatePreview);
      signatureInput.addEventListener('input', updatePreview);
      messageInput.addEventListener('input', updatePreview);

      const form = document.getElementById("letterForm");
      if (!form) return;

      form.addEventListener("submit", function (event) {
        event.preventDefault();

        // Clean + normalize openAfterDays
        const rawOpenAfter = parseInt(form.openAfterDays.value, 10);
        let safeOpenAfterDays = Number.isNaN(rawOpenAfter)
          ? defaultOpenAfterDays
          : rawOpenAfter;

        // No negative values
        if (safeOpenAfterDays < 0) safeOpenAfterDays = 0;

        const data = {
          name: form.name.value.trim(),
          date: form.date.value.trim(),
          message: form.message.value.trim(),
          signature: form.signature.value.trim(),
          createdAt: new Date().toISOString(),
          openAfterDays: safeOpenAfterDays
        };

        // Pull existing letters from localStorage
        const existing = localStorage.getItem("sentLetters");
        let letters = [];
        if (existing) {
          try {
            letters = JSON.parse(existing);
            if (!Array.isArray(letters)) letters = [];
          } catch {
            letters = [];
          }
        }

        // Add the new letter
        letters.push(data);
        localStorage.setItem("sentLetters", JSON.stringify(letters));

        // Redirect to confirmation page
        window.location.href = "sent.html";
      });
    });
  </script>
  <script src="js/search.js"></script>
  <script src="js/theme.js"></script>

</body>
</html>
